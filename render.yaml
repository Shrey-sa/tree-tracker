# Render Blueprint - Auto-deploys entire stack
# Docs: https://render.com/docs/blueprint-spec

services:
  # ── Django Backend ─────────────────────────────
  - type: web
    name: treetracker-backend
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: free
    healthCheckPath: /api/schema/
    envVars:
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: False
      - key: ALLOWED_HOSTS
        value: treetracker-backend.onrender.com,localhost
      - key: DATABASE_URL
        fromDatabase:
          name: treetracker-db
          property: connectionString
      - key: REDIS_URL
        value: your-upstash-redis-url  # replace with Upstash URL
      - key: CORS_ALLOWED_ORIGINS
        value: https://your-app.vercel.app  # replace after Vercel deploy
      - key: EMAIL_BACKEND
        value: django.core.mail.backends.console.EmailBackend
      - key: DEFAULT_FROM_EMAIL
        value: TreeTracker <noreply@example.com>
    buildCommand: pip install -r requirements.txt
    startCommand: >
      sh -c "python manage.py migrate &&
             python manage.py seed_data &&
             python manage.py collectstatic --noinput &&
             gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 2"

  # ── Celery Worker ──────────────────────────────
  - type: worker
    name: treetracker-celery
    runtime: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: free
    envVars:
      - key: SECRET_KEY
        fromService:
          name: treetracker-backend
          type: web
          envVarKey: SECRET_KEY
      - key: DEBUG
        value: False
      - key: DATABASE_URL
        fromDatabase:
          name: treetracker-db
          property: connectionString
      - key: REDIS_URL
        value: your-upstash-redis-url
    startCommand: celery -A config worker --beat --loglevel=info

databases:
  # ── PostgreSQL ─────────────────────────────────
  - name: treetracker-db
    plan: free
    databaseName: treetracker
    user: treetracker
